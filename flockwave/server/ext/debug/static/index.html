<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Flockwave Test Client</title>

        <link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.6/lumen/bootstrap.min.css" rel="stylesheet">

        <style>
        #messageToSend {
            font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
            font-size: 1em;
        }
        </style>
    </head>
    <body>

        <div class="container">

            <h1>Flockwave test client</h1>

            <p class="lead">Use the form below to send test messages to this
                Flockwave server. Predefined message templates may be loaded
                with the buttons on the right.
            </p>

            <form>
                <fieldset class="form-group">
                    <label for="messageToSend">Message</label>
                    <textarea id="messageToSend" class="form-control" rows="8"
                        placeholder="Send a message to the server...">
                    </textarea>
                </fieldset>

                <button type="button" class="btn btn-primary" onclick="send(); return false;">Send</button>
                <button type="button" class="btn btn-default" onclick="disconnect(); return false;">Disconnect</button>

                <div class="pull-right">
                    <div class="btn-group">
                        <button type="button" id="preset-dropdown-button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Presets <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" id="preset-buttons">
                        </ul>
                    </div>
                </div>
            </form>

            <h2>Server responses</h2>

            <div id="responses">
                <p class="lead hint">Responses from the server will appear here.</p>
            </div>

            <h2>Notifications</h2>

            <div id="notifications">
                <p class="lead hint">Notifications from the server will appear here.</p>
            </div>
        </div>

        <!-- ########################################################## -->

        <script type="text/javascript" src="//cdn.socket.io/socket.io-1.3.7.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

        <script type="text/javascript">
            var presets = {
                "CMD-DEL": {
                    "type": "CMD-DEL",
                    "ids": []
                },
                "CMD-INF": {
                    "type": "CMD-INF",
                    "ids": []
                },
                "CMD-REQ": {
                    "type": "CMD-REQ",
                    "ids": ["FAKE-01", "FAKE-02"],
                    "command": "yo"
                },
                "CONN-INF": {
                    "type": "CONN-INF",
                    "ids": ["fakeConnection0", "fakeConnection1"]
                },
                "CONN-LIST": {
                    "type": "CONN-LIST"
                },
                "SYS-PING": {
                    "type": "SYS-PING"
                },
                "SYS-VER": {
                    "type": "SYS-VER"
                },
                "UAV-INF": {
                    "type": "UAV-INF",
                    "ids": ["FAKE-01", "FAKE-02"]
                },
                "UAV-LAND": {
                    "type": "UAV-LAND",
                    "ids": ["FAKE-00"]
                },
                "UAV-LIST": {
                    "type": "UAV-LIST"
                },
                "UAV-TAKEOFF": {
                    "type": "UAV-TAKEOFF",
                    "ids": ["FAKE-00"]
                },
            };
            var socket = io();
            var $responsePanel = $('#responses');
            var $notificationPanel = $('#notifications');

            socket.on('fw', function(data) {
                if (data.hasOwnProperty("correlationId")) {
                    addEntryToPanel(data, $responsePanel);
                } else {
                    addEntryToPanel(data, $notificationPanel);
                }
            });

            function addEntryToPanel(data, $panel) {
                $panel.find('.hint').hide();
                $('<pre>').text(
                    JSON.stringify(data, null, '    ')
                ).hide().prependTo($panel).slideDown();
                $panel.children('pre:gt(50)').remove();
            }

            function guid() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = crypto.getRandomValues(new Uint8Array(1))[0]%16|0, v = c == 'x' ? r : (r&0x3|0x8);
                    return v.toString(16);
                });
            }

            function disconnect(){
                socket.disconnect();
            }

            function loadPreset(name) {
                $('#messageToSend').val(JSON.stringify(presets[name], null, "    "));
            }

            function preparePresetButtons() {
                var $presetDropdownButton = $('#preset-dropdown-button');
                var $presetButtons = $('#preset-buttons');
                var presetNames = $.map(presets,
                    function(preset, presetName) {
                        return presetName;
                    });
                presetNames.sort();

                $.each(presetNames, function(index, presetName) {
                    $('<a href="#">')
                        .on("click", function() {
                            loadPreset(presetName);
                            $presetDropdownButton.dropdown('toggle');
                            return false;
                        })
                        .text(presetName)
                        .wrap('<li>').parent()
                        .appendTo($presetButtons);
                });
            }

            function send() {
                var body = $('#messageToSend').val();
                var parsedBody;
                var message;

                try {
                    parsedBody = JSON.parse(body);
                } catch (e) {
                    alert("Message is not a valid JSON object.");
                    return;
                }

                if (!parsedBody.hasOwnProperty("type")) {
                    alert("Message must have a 'type' property.");
                    return;
                }

                message = {
                    "$fw.version": "1.0",
                    "id": guid(),
                    "body": parsedBody
                }

                socket.emit("fw", message);
            }

            $(function() {
                preparePresetButtons();
                loadPreset('SYS-VER');
            });
        </script>
    </body>
</html>
